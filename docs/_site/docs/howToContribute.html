<html><head><title>GEM Library: How to contribute</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Jean-Daniel Bancal" /><meta name="description" content="Gmp Eigen Matrix Library" /><meta name="og:image" content="http://localhost:4000/gem/img/poster.png" /><meta name="og:title" content="GEM Library: How to contribute" /><meta name="og:site_name" content="GEM Library" /><meta name="og:url" content="http://gem-library.github.io/gem" /><meta name="og:type" content="website" /><meta name="og:description" content="Gmp Eigen Matrix Library" /><link rel="icon" type="image/png" href="http://localhost:4000/gem/img/favicon.png" /><meta name="twitter:title" content="GEM Library: How to contribute" /><meta name="twitter:image" content="https://farm6.staticflickr.com/5510/14338202952_93595258ff_z.jpg" /><meta name="twitter:description" content="Gmp Eigen Matrix Library" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="http://localhost:4000/gem/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="http://localhost:4000/gem/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="http://localhost:4000/gem/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="http://localhost:4000/gem/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="http://localhost:4000/gem/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="http://localhost:4000/gem/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="http://localhost:4000/gem/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="http://localhost:4000/gem/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="http://localhost:4000/gem/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="http://localhost:4000/gem/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="http://localhost:4000/gem/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="http://localhost:4000/gem/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="http://localhost:4000/gem/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="http://localhost:4000/gem/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="http://localhost:4000/gem/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="http://localhost:4000/gem/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="http://localhost:4000/gem/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="http://localhost:4000/gem/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="http://localhost:4000/gem/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="http://localhost:4000/gem/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="http://localhost:4000/gem/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/gem/css/style.css" /><link rel="stylesheet" href="/gem/css/palette.css" /><link rel="stylesheet" href="/gem/css/codemirror.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/gem/" class="brand"><div class="brand-wrapper"><span>GEM Library</span></div></a></li> <li><a href="/gem/docs/installation.html" class="">Installation</a></li> <li><a href="/gem/docs/gettingStarted.html" class="">Getting started</a></li> <li><a href="/gem/docs/publish/examples.html" class="">Examples</a></li> <li><a href="/gem/docs/functions.html" class="">Available functions</a></li> <li><a href="/gem/docs/howToContribute.html" class=" active ">How to contribute</a></li> <li><a href="/gem/docs/compilationInstructions.html" class="">Compilation instructions</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/gem-library/gem"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/gem-library/gem"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('GEM Library');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('GEM Library');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="gem-library" data-github-repo="gem"><div class="content-wrapper"><section><h1 id="how-to-contribute">How to contribute</h1>

<p>This page presents some useful information for contributing to the <strong>GEM Library</strong>.</p>

<h2 id="workflow">Workflow</h2>

<p>Improvements to the code should be performed on a fork of the github repository (see <a href="https://docs.gitlab.com/ce/workflow/forking_workflow.html"><strong>here</strong></a> for information on git related collaborative programming). In case you are wondering what kind of features could be still worth implementing in the library, a few ideas are listed at the <a href="#desired-features"><strong>end</strong></a> of this file.</p>

<h2 id="general-code-structure">General code structure</h2>

<p>Part of the source code of the <strong>GEM Library</strong> is written in Matlab/Octave and part is in C++. The C++ code is used for efficiency puspose, while the Matlab/Octave code is used mostly for interface purpose, and for higher-level programming.</p>

<p>Overall, the code is structured in 4 levels:</p>

<ul>
  <li>C++ methods in <code class="highlighter-rouge">src/gem.cpp</code> and <code class="highlighter-rouge">src/sgem.cpp</code> (plus the corresponding header files). This code is doing the actual job. Each full and sparse implementation (if applicable) is always provided in two forms:
    <ul>
      <li>as a function like <code class="highlighter-rouge">abs()</code> providing the ouput as an object</li>
      <li>as a function like <code class="highlighter-rouge">abs_new()</code> providing the output as a reference to a new object</li>
    </ul>
  </li>
  <li>C++ files <code class="highlighter-rouge">src/gem_mex.cpp</code> and <code class="highlighter-rouge">src/sgem_mex.cpp</code>. These serve as dispatchers: receiving the direct instructions from Matlab/Octave, they instantiate the necessary objects and call the underlying C++ methods.</li>
  <li>Functions in the folder <code class="highlighter-rouge">gem/@gem</code> and <code class="highlighter-rouge">gem/@sgem</code>. These are part of the definition of the <code class="highlighter-rouge">gem</code> and <code class="highlighter-rouge">sgem</code> classes which are run by Matlab/Octave directly. They can access the C++ functionalities through the function <code class="highlighter-rouge">gem_mex</code> and <code class="highlighter-rouge">sgem_mex</code>.</li>
  <li>Test functions in the folder <code class="highlighter-rouge">tests</code> (each filename finishes with ‘_test.m’). These functions are responsible for testing the proper behavior of one class function.</li>
</ul>

<p>Every feature should appear in all 4 levels. For instance, the code corresponding to the <code class="highlighter-rouge">abs</code> function is constituted of the following files/methods:</p>

<ul>
  <li><code class="highlighter-rouge">tests/gem/abs_test.m</code> and <code class="highlighter-rouge">tests/sgem/abs_test.m</code> which test this functionality on <code class="highlighter-rouge">gem</code> and <code class="highlighter-rouge">sgem</code> objects</li>
  <li><code class="highlighter-rouge">gem/gem/abs.m</code> and <code class="highlighter-rouge">gem/sgem/abs.m</code>, the full and sparse methods</li>
  <li><code class="highlighter-rouge">if (!strcmp("abs", cmd))</code> cases in <code class="highlighter-rouge">src/gem_mex.cpp</code> and <code class="highlighter-rouge">src/sgem_mex.cpp</code>. These receive the calls from Matlab/Octave.</li>
  <li><code class="highlighter-rouge">GmpEigenMatrix abs() const;</code>, <code class="highlighter-rouge">GmpEigenMatrix&amp; abs_new() const;</code> in <code class="highlighter-rouge">src/gem.hpp</code> and <code class="highlighter-rouge">SparseGmpEigenMatrix abs() const;</code>, <code class="highlighter-rouge">SparseGmpEigenMatrix&amp; abs_new() const;</code> in <code class="highlighter-rouge">src/sgem.hpp</code>. These functions perform the operation <code class="highlighter-rouge">abs</code> on the high precision C++ data structures.</li>
</ul>

<h2 id="step-by-step-implementation-of-a-new-functionality">Step by step implementation of a new functionality</h2>

<p>Havin forked a version of the source code to work on, here is how to proceed to implement a new particular function:</p>
<ul>
  <li>First of all, identify some general feature of the considered function:
    <ul>
      <li>How many parameters does the function depends on? Which of these parameters can be gem objects, which ones must be indices? If there are several input gem parameters, do they all need to be of the same size, or can the function mix matrices and scalars?</li>
      <li>How many outputs does this function produce? Which ones are gem objects or indices?</li>
      <li>Does the function preserve sparsity? (i.e. are there sparse inputs which can produce sparse outputs? This is not the case of the cosine functions, for instance.)</li>
    </ul>
  </li>
  <li>Identify an existing gem function which has identical or similar properties (e.g. <code class="highlighter-rouge">tan(x)</code> is similar to <code class="highlighter-rouge">sin(x)</code>, <code class="highlighter-rouge">plus(x,y)</code> is <em>not</em> similar to <code class="highlighter-rouge">find(x)</code>), and read the code related to this function (both Matlab/Octave and C++ code).</li>
  <li>Copy this function and rename it according to the new function. Do this in the <code class="highlighter-rouge">@gem</code> folder, <code class="highlighter-rouge">src/gem_mex.cpp</code> file, <code class="highlighter-rouge">src/gem.hpp</code> file, <code class="highlighter-rouge">src/gem.cpp</code> file first.</li>
  <li>Now these new pieces of code can be modified to implement the new function.</li>
  <li>Compile the code and test it.</li>
  <li>It should now be straightforward to implement the function for sparse matrices as well by copying and modifying the files/functions in the <code class="highlighter-rouge">@sgem</code> folder, <code class="highlighter-rouge">src/sgem_mex.cpp</code> file, <code class="highlighter-rouge">src/sgem.hpp</code> file, <code class="highlighter-rouge">src/sgem.cpp</code> file. If the function never preserves sparsity, no modification of the src folder is required at this stage, though: you only need to perform modification of the matlab code in the <code class="highlighter-rouge">@sgem</code> folder.</li>
  <li>Compile and check the code written for sparse matrices.</li>
  <li>Make sure that the code has a minimal amount of help information (including e.g. a usage example) and that it contains a few helpful comments that explain what is happening.</li>
  <li>If this was not done yet, add tests dedicated to this new function in the folders <code class="highlighter-rouge">tests/gem</code> and <code class="highlighter-rouge">tests/sgem</code>. Check that the tests are passed by the implementation.</li>
  <li>When all is fine, send a pull request on github to add a new feature to the library!</li>
</ul>

<h2 id="further-design-considerations">Further design considerations</h2>

<ul>
  <li>
    <p>By default, truly sparse operations are implemented only if there is a chance that the result of the operation applied to a sparse matrix produces a sparse result. This diverges from matlab’s default behavior. However, matlab’s default behavior can be restored through the function ‘gem.sparseLikeMatlab’.</p>

    <p>This means that <code class="highlighter-rouge">sin(x)</code> has a sparse implementation, but not <code class="highlighter-rouge">cos(x)</code> (<code class="highlighter-rouge">sin(0) = 0</code>, but <code class="highlighter-rouge">cos(0)</code> is not <code class="highlighter-rouge">0</code>). The implementation of the cosine function for sparse objects thus starts by a casting of the input into a full matrix, before calling the full implementation of the cosine function (see <code class="highlighter-rouge">@sgem/cos.m</code> for an example). Also the matrix inverse function <code class="highlighter-rouge">inv(X)</code> admits a sparse implementation, even though the inverse of most sparse matrices is not sparse. This is because there exist sparse matrices X whose inverse is also sparse (e.g. <code class="highlighter-rouge">X = eye(d)</code>).</p>
  </li>
  <li>
    <p>The library uses the data type <em>mpreal</em> provided by the mpfrc++ library. Therefore, it deals with complex numbers by itself, storing the real and imaginary components of complex objects in two different matrices. In particular, all interactions with the Eigen library involves purely real numbers.</p>

    <p>Note that relying on std::complex is risky, because several algorithms assume that <code class="highlighter-rouge">std::complex</code> comes with double precision, hence leading to a loss of precision (c.f. comment from April 20, 2016 on http://www.holoborodko.com/pavel/mpfr/). Since the complex algebra is contained in the matrix algebra, complex operations can be implemented as matrix operations.</p>
  </li>
  <li>The fact that the library interfaces with Matlab/Octave requires a dynamical allocation of objects. This is taken care of by a class adapted from <a href="https://fr.mathworks.com/matlabcentral/fileexchange/38964-example-matlab-class-wrapper-for-a-c++-class">this C++ class interface</a>. One consequence is that most methods in the C++ code have two variants (as mentioned above) :
    <ul>
      <li><code class="highlighter-rouge">method</code> which performs the required computation and returns the result in a static variable (this variable is cleared once the library returns to matlab).</li>
      <li><code class="highlighter-rouge">method_new</code> which performs the same operation but returns the result in a dynamic variable (this variable remains in memory between to calls from matlab).</li>
    </ul>

    <p>The code of both functions must be identical, except for the variable definition.</p>
  </li>
  <li>The Matlab/Octave is responsible of performing all parameters checks before calling the C++ library. So for instance it must check that the size of two matrices are compatible before asking the C++ library to multiply these matrices. No such checks should be expected to be performed on the C++ side. This is meant to lighten the C++ code, which is already complex enough as is.</li>
</ul>

<h2 id="desired-features">Desired Features</h2>

<p>Here is a partial list of features/functions that would be nice to add to the library.</p>

<ul>
  <li>improve the function <code class="highlighter-rouge">sprintf</code> to provide all digits</li>
  <li>Implement the matrix <code class="highlighter-rouge">mpower</code> function for powers different from +/-1.</li>
  <li>Implement the matrix exponential function <code class="highlighter-rouge">expm</code></li>
  <li>Parallelize the for loops appearing in simple functions such as <code class="highlighter-rouge">sin</code>.</li>
  <li><code class="highlighter-rouge">triu</code>, <code class="highlighter-rouge">tril</code></li>
  <li>Beta special functions: <code class="highlighter-rouge">beta</code>, <code class="highlighter-rouge">betainv</code>, <code class="highlighter-rouge">betainc</code>, <code class="highlighter-rouge">betaincinv</code></li>
  <li>Systematically check for behavior of functions on <code class="highlighter-rouge">NaN</code>, <code class="highlighter-rouge">-Inf</code>, <code class="highlighter-rouge">Inf</code></li>
  <li>Define a strategy for empty matrices of various sizes, i.e. difference between 0x0, 1x0, 10x0, 0x1, … empty matrices. Implement, check behavior of all functions on these objects and test it.</li>
  <li>For more ways to contribute, please see the <a href="http://github.com/gem-library/gem/issues"><strong>open issues</strong></a></li>
</ul>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="http://localhost:4000/gem/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['matlab']
});
      $(document).ready(function() {
      $('pre.codeoutput').each(function(i, block) {
      hljs.highlightBlock(block);
      });
      });
    </script><script>((window.gitter = {}).chat = {}).options = {
room: 'gem-library/gem'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/gem/js/main.js"></script></body></html>
